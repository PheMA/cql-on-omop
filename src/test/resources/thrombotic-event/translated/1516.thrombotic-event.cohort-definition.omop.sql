CREATETABLE#Codesets(codeset_idintNOTNULL,concept_idbigintNOTNULL);
INSERTINTO#Codesets(codeset_id,concept_id)SELECT0ascodeset_id,c.concept_idFROM(selectdistinctI.concept_idFROM(selectconcept_idfrom@vocabulary_database_schema.CONCEPTwhereconcept_idin(123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123)andinvalid_reasonisnull)I)C;
INSERTINTO#Codesets(codeset_id,concept_id)SELECT1ascodeset_id,c.concept_idFROM(selectdistinctI.concept_idFROM(selectconcept_idfrom@vocabulary_database_schema.CONCEPTwhereconcept_idin(123,123)andinvalid_reasonisnull)I)C;
INSERTINTO#Codesets(codeset_id,concept_id)SELECT2ascodeset_id,c.concept_idFROM(selectdistinctI.concept_idFROM(selectconcept_idfrom@vocabulary_database_schema.CONCEPTwhereconcept_idin(123,123,123,123,123,123,123,123,123,123,123,123,123)andinvalid_reasonisnull)I)C;
INSERTINTO#Codesets(codeset_id,concept_id)SELECT3ascodeset_id,c.concept_idFROM(selectdistinctI.concept_idFROM(selectconcept_idfrom@vocabulary_database_schema.CONCEPTwhereconcept_idin(123,123,123,123,123,123,123,123,123,123,123,123,123,123)andinvalid_reasonisnull)I)C;
INSERTINTO#Codesets(codeset_id,concept_id)SELECT4ascodeset_id,c.concept_idFROM(selectdistinctI.concept_idFROM(selectconcept_idfrom@vocabulary_database_schema.CONCEPTwhereconcept_idin(123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123)andinvalid_reasonisnull)I)C;
INSERTINTO#Codesets(codeset_id,concept_id)SELECT5ascodeset_id,c.concept_idFROM(selectdistinctI.concept_idFROM(selectconcept_idfrom@vocabulary_database_schema.CONCEPTwhereconcept_idin(123,123)andinvalid_reasonisnull)I)C;
INSERTINTO#Codesets(codeset_id,concept_id)SELECT6ascodeset_id,c.concept_idFROM(selectdistinctI.concept_idFROM(selectconcept_idfrom@vocabulary_database_schema.CONCEPTwhereconcept_idin(123)andinvalid_reasonisnull)I)C;
INSERTINTO#Codesets(codeset_id,concept_id)SELECT7ascodeset_id,c.concept_idFROM(selectdistinctI.concept_idFROM(selectconcept_idfrom@vocabulary_database_schema.CONCEPTwhereconcept_idin(123,123,123,123)andinvalid_reasonisnull)I)C;
INSERTINTO#Codesets(codeset_id,concept_id)SELECT8ascodeset_id,c.concept_idFROM(selectdistinctI.concept_idFROM(selectconcept_idfrom@vocabulary_database_schema.CONCEPTwhereconcept_idin(123)andinvalid_reasonisnull)I)C;
INSERTINTO#Codesets(codeset_id,concept_id)SELECT9ascodeset_id,c.concept_idFROM(selectdistinctI.concept_idFROM(selectconcept_idfrom@vocabulary_database_schema.CONCEPTwhereconcept_idin(123,123)andinvalid_reasonisnull)I)C;
INSERTINTO#Codesets(codeset_id,concept_id)SELECT10ascodeset_id,c.concept_idFROM(selectdistinctI.concept_idFROM(selectconcept_idfrom@vocabulary_database_schema.CONCEPTwhereconcept_idin(123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123)andinvalid_reasonisnull)I)C;
INSERTINTO#Codesets(codeset_id,concept_id)SELECT11ascodeset_id,c.concept_idFROM(selectdistinctI.concept_idFROM(selectconcept_idfrom@vocabulary_database_schema.CONCEPTwhereconcept_idin(123,123,123)andinvalid_reasonisnull)I)C;
INSERTINTO#Codesets(codeset_id,concept_id)SELECT12ascodeset_id,c.concept_idFROM(selectdistinctI.concept_idFROM(selectconcept_idfrom@vocabulary_database_schema.CONCEPTwhereconcept_idin(123,123,123,123,123,123,123,123,123)andinvalid_reasonisnull)I)C;
INSERTINTO#Codesets(codeset_id,concept_id)SELECT13ascodeset_id,c.concept_idFROM(selectdistinctI.concept_idFROM(selectconcept_idfrom@vocabulary_database_schema.CONCEPTwhereconcept_idin(123)andinvalid_reasonisnull)I)C;
INSERTINTO#Codesets(codeset_id,concept_id)SELECT14ascodeset_id,c.concept_idFROM(selectdistinctI.concept_idFROM(selectconcept_idfrom@vocabulary_database_schema.CONCEPTwhereconcept_idin(123)andinvalid_reasonisnull)I)C;
INSERTINTO#Codesets(codeset_id,concept_id)SELECT15ascodeset_id,c.concept_idFROM(selectdistinctI.concept_idFROM(selectconcept_idfrom@vocabulary_database_schema.CONCEPTwhereconcept_idin(123,123,123,123,123,123)andinvalid_reasonisnull)I)C;
INSERTINTO#Codesets(codeset_id,concept_id)SELECT16ascodeset_id,c.concept_idFROM(selectdistinctI.concept_idFROM(selectconcept_idfrom@vocabulary_database_schema.CONCEPTwhereconcept_idin(123)andinvalid_reasonisnull)I)C;
INSERTINTO#Codesets(codeset_id,concept_id)SELECT17ascodeset_id,c.concept_idFROM(selectdistinctI.concept_idFROM(selectconcept_idfrom@vocabulary_database_schema.CONCEPTwhereconcept_idin(123)andinvalid_reasonisnull)I)C;
INSERTINTO#Codesets(codeset_id,concept_id)SELECT18ascodeset_id,c.concept_idFROM(selectdistinctI.concept_idFROM(selectconcept_idfrom@vocabulary_database_schema.CONCEPTwhereconcept_idin(123)andinvalid_reasonisnull)I)C;
INSERTINTO#Codesets(codeset_id,concept_id)SELECT19ascodeset_id,c.concept_idFROM(selectdistinctI.concept_idFROM(selectconcept_idfrom@vocabulary_database_schema.CONCEPTwhereconcept_idin(123,123,123,123,123,123,123,123,123,123)andinvalid_reasonisnull)I)C;
INSERTINTO#Codesets(codeset_id,concept_id)SELECT20ascodeset_id,c.concept_idFROM(selectdistinctI.concept_idFROM(selectconcept_idfrom@vocabulary_database_schema.CONCEPTwhereconcept_idin(123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123)andinvalid_reasonisnull)I)C;
INSERTINTO#Codesets(codeset_id,concept_id)SELECT21ascodeset_id,c.concept_idFROM(selectdistinctI.concept_idFROM(selectconcept_idfrom@vocabulary_database_schema.CONCEPTwhereconcept_idin(123,123,123,123,123)andinvalid_reasonisnull)I)C;
INSERTINTO#Codesets(codeset_id,concept_id)SELECT22ascodeset_id,c.concept_idFROM(selectdistinctI.concept_idFROM(selectconcept_idfrom@vocabulary_database_schema.CONCEPTwhereconcept_idin(123,123)andinvalid_reasonisnull)I)C;
INSERTINTO#Codesets(codeset_id,concept_id)SELECT23ascodeset_id,c.concept_idFROM(selectdistinctI.concept_idFROM(selectconcept_idfrom@vocabulary_database_schema.CONCEPTwhereconcept_idin(123,123,123,123)andinvalid_reasonisnull)I)C;
INSERTINTO#Codesets(codeset_id,concept_id)SELECT24ascodeset_id,c.concept_idFROM(selectdistinctI.concept_idFROM(selectconcept_idfrom@vocabulary_database_schema.CONCEPTwhereconcept_idin(123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123)andinvalid_reasonisnull)I)C;
INSERTINTO#Codesets(codeset_id,concept_id)SELECT25ascodeset_id,c.concept_idFROM(selectdistinctI.concept_idFROM(selectconcept_idfrom@vocabulary_database_schema.CONCEPTwhereconcept_idin(123,123)andinvalid_reasonisnull)I)C;
withprimary_events(event_id,person_id,start_date,end_date,op_start_date,op_end_date,visit_occurrence_id)as(--BeginPrimaryEventsselectrow_number()over(PARTITIONBYP.person_idorderbyP.start_date)asevent_id,P.person_id,P.start_date,P.end_date,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_date,cast(P.visit_occurrence_idasbigint)asvisit_occurrence_idFROM(selectP.person_id,P.start_date,P.end_date,row_number()OVER(PARTITIONBYperson_idORDERBYstart_dateASC)ordinal,cast(P.visit_occurrence_idasbigint)asvisit_occurrence_idFROM(--BeginVisitOccurrenceCriteriaselectC.person_id,C.visit_occurrence_idasevent_id,C.visit_start_dateasstart_date,C.visit_end_dateasend_date,C.visit_concept_idasTARGET_CONCEPT_ID,C.visit_occurrence_idfrom(selectvo.*,row_number()over(PARTITIONBYvo.person_idORDERBYvo.visit_start_date,vo.visit_occurrence_id)asordinalFROM@cdm_database_schema.VISIT_OCCURRENCEvo)C--EndVisitOccurrenceCriteria)P)PJOIN@cdm_database_schema.observation_periodOPonP.person_id=OP.person_idandP.start_date>=OP.observation_period_start_dateandP.start_date<=op.observation_period_end_dateWHEREDATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE)<=P.START_DATEANDDATEADD(day,0,P.START_DATE)<=OP.OBSERVATION_PERIOD_END_DATEANDP.ordinal=1--EndPrimaryEvents)SELECTevent_id,person_id,start_date,end_date,op_start_date,op_end_date,visit_occurrence_idINTO#qualified_eventsFROM(selectpe.event_id,pe.person_id,pe.start_date,pe.end_date,pe.op_start_date,pe.op_end_date,row_number()over(partitionbype.person_idorderbype.start_dateASC)asordinal,cast(pe.visit_occurrence_idasbigint)asvisit_occurrence_idFROMprimary_eventspe)QE;---InclusionRuleInsertsselect0asinclusion_rule_id,person_id,event_idINTO#Inclusion_0FROM(selectpe.person_id,pe.event_idFROM#qualified_eventspeJOIN(--BeginCriteriaGroupselect0asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM#qualified_eventsELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM#qualified_eventsPLEFTJOIN(selectPE.person_id,PE.event_id,PE.start_date,PE.end_date,PE.target_concept_id,PE.visit_occurrence_idFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=23))C--EndConditionOccurrenceCriteria)PEJOIN(--BeginCriteriaGroupselect0asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=23))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)ELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=23))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)PLEFTJOIN(--BeginDrugExposureCriteriaselectC.person_id,C.drug_exposure_idasevent_id,C.drug_exposure_start_dateasstart_date,COALESCE(C.drug_exposure_end_date,DATEADD(day,1,C.drug_exposure_start_date))asend_date,C.drug_concept_idasTARGET_CONCEPT_ID,C.visit_occurrence_idfrom(selectde.*,row_number()over(PARTITIONBYde.person_idORDERBYde.drug_exposure_start_date,de.drug_exposure_id)asordinalFROM@cdm_database_schema.DRUG_EXPOSUREdewherede.drug_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=24))C--EndDrugExposureCriteria)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=DATEADD(day,-7,P.START_DATE)andA.START_DATE<=DATEADD(day,7,P.START_DATE)GROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteria)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)=1)G--EndCriteriaGroup)AConAC.person_id=pe.person_idandAC.event_id=pe.event_id)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=P.OP_START_DATEandA.START_DATE<=P.OP_END_DATEGROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteriaUNIONALL--BeginCriteriaGroupselect1asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM#qualified_eventsELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM#qualified_eventsPLEFTJOIN(selectPE.person_id,PE.event_id,PE.start_date,PE.end_date,PE.target_concept_id,PE.visit_occurrence_idFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=22))C--EndConditionOccurrenceCriteria)PEJOIN(--BeginCriteriaGroupselect0asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=22))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)ELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=22))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)PLEFTJOIN(--BeginDrugExposureCriteriaselectC.person_id,C.drug_exposure_idasevent_id,C.drug_exposure_start_dateasstart_date,COALESCE(C.drug_exposure_end_date,DATEADD(day,1,C.drug_exposure_start_date))asend_date,C.drug_concept_idasTARGET_CONCEPT_ID,C.visit_occurrence_idfrom(selectde.*,row_number()over(PARTITIONBYde.person_idORDERBYde.drug_exposure_start_date,de.drug_exposure_id)asordinalFROM@cdm_database_schema.DRUG_EXPOSUREdewherede.drug_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=24))C--EndDrugExposureCriteria)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=DATEADD(day,-7,P.START_DATE)andA.START_DATE<=DATEADD(day,7,P.START_DATE)GROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteria)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)=1)G--EndCriteriaGroup)AConAC.person_id=pe.person_idandAC.event_id=pe.event_id)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=P.OP_START_DATEandA.START_DATE<=P.OP_END_DATEGROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteriaUNIONALL--BeginCriteriaGroupselect1asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM#qualified_eventsELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM#qualified_eventsPLEFTJOIN(selectPE.person_id,PE.event_id,PE.start_date,PE.end_date,PE.target_concept_id,PE.visit_occurrence_idFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=21))C--EndConditionOccurrenceCriteria)PEJOIN(--BeginCriteriaGroupselect0asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=21))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)ELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=21))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)PLEFTJOIN(--BeginDrugExposureCriteriaselectC.person_id,C.drug_exposure_idasevent_id,C.drug_exposure_start_dateasstart_date,COALESCE(C.drug_exposure_end_date,DATEADD(day,1,C.drug_exposure_start_date))asend_date,C.drug_concept_idasTARGET_CONCEPT_ID,C.visit_occurrence_idfrom(selectde.*,row_number()over(PARTITIONBYde.person_idORDERBYde.drug_exposure_start_date,de.drug_exposure_id)asordinalFROM@cdm_database_schema.DRUG_EXPOSUREdewherede.drug_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=24))C--EndDrugExposureCriteria)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=DATEADD(day,-7,P.START_DATE)andA.START_DATE<=DATEADD(day,7,P.START_DATE)GROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteria)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)=1)G--EndCriteriaGroup)AConAC.person_id=pe.person_idandAC.event_id=pe.event_id)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=P.OP_START_DATEandA.START_DATE<=P.OP_END_DATEGROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteriaUNIONALL--BeginCriteriaGroupselect1asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM#qualified_eventsELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM#qualified_eventsPLEFTJOIN(selectPE.person_id,PE.event_id,PE.start_date,PE.end_date,PE.target_concept_id,PE.visit_occurrence_idFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=20))C--EndConditionOccurrenceCriteria)PEJOIN(--BeginCriteriaGroupselect0asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=20))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)ELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=20))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)PLEFTJOIN(--BeginDrugExposureCriteriaselectC.person_id,C.drug_exposure_idasevent_id,C.drug_exposure_start_dateasstart_date,COALESCE(C.drug_exposure_end_date,DATEADD(day,1,C.drug_exposure_start_date))asend_date,C.drug_concept_idasTARGET_CONCEPT_ID,C.visit_occurrence_idfrom(selectde.*,row_number()over(PARTITIONBYde.person_idORDERBYde.drug_exposure_start_date,de.drug_exposure_id)asordinalFROM@cdm_database_schema.DRUG_EXPOSUREdewherede.drug_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=24))C--EndDrugExposureCriteria)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=DATEADD(day,-7,P.START_DATE)andA.START_DATE<=DATEADD(day,7,P.START_DATE)GROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteria)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)=1)G--EndCriteriaGroup)AConAC.person_id=pe.person_idandAC.event_id=pe.event_id)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=P.OP_START_DATEandA.START_DATE<=P.OP_END_DATEGROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteriaUNIONALL--BeginCriteriaGroupselect1asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM#qualified_eventsELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM#qualified_eventsPLEFTJOIN(selectPE.person_id,PE.event_id,PE.start_date,PE.end_date,PE.target_concept_id,PE.visit_occurrence_idFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=19))C--EndConditionOccurrenceCriteria)PEJOIN(--BeginCriteriaGroupselect0asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=19))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)ELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=19))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)PLEFTJOIN(--BeginDrugExposureCriteriaselectC.person_id,C.drug_exposure_idasevent_id,C.drug_exposure_start_dateasstart_date,COALESCE(C.drug_exposure_end_date,DATEADD(day,1,C.drug_exposure_start_date))asend_date,C.drug_concept_idasTARGET_CONCEPT_ID,C.visit_occurrence_idfrom(selectde.*,row_number()over(PARTITIONBYde.person_idORDERBYde.drug_exposure_start_date,de.drug_exposure_id)asordinalFROM@cdm_database_schema.DRUG_EXPOSUREdewherede.drug_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=24))C--EndDrugExposureCriteria)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=DATEADD(day,-7,P.START_DATE)andA.START_DATE<=DATEADD(day,7,P.START_DATE)GROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteria)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)=1)G--EndCriteriaGroup)AConAC.person_id=pe.person_idandAC.event_id=pe.event_id)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=P.OP_START_DATEandA.START_DATE<=P.OP_END_DATEGROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteriaUNIONALL--BeginCriteriaGroupselect1asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM#qualified_eventsELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM#qualified_eventsPLEFTJOIN(selectPE.person_id,PE.event_id,PE.start_date,PE.end_date,PE.target_concept_id,PE.visit_occurrence_idFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=15))C--EndConditionOccurrenceCriteria)PEJOIN(--BeginCriteriaGroupselect0asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=15))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)ELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=15))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)PLEFTJOIN(--BeginMeasurementCriteriaselectC.person_id,C.measurement_idasevent_id,C.measurement_dateasstart_date,DATEADD(d,1,C.measurement_date)asEND_DATE,C.measurement_concept_idasTARGET_CONCEPT_ID,C.visit_occurrence_idfrom(selectm.*,row_number()over(PARTITIONBYm.person_idORDERBYm.measurement_date,m.measurement_id)asordinalFROM@cdm_database_schema.MEASUREMENTmwherem.measurement_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=11))C--EndMeasurementCriteria)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=DATEADD(day,-7,P.START_DATE)andA.START_DATE<=DATEADD(day,7,P.START_DATE)GROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteriaUNIONALL--BeginCriteriaGroupselect1asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=15))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)ELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=15))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)PLEFTJOIN(--BeginDrugExposureCriteriaselectC.person_id,C.drug_exposure_idasevent_id,C.drug_exposure_start_dateasstart_date,COALESCE(C.drug_exposure_end_date,DATEADD(day,1,C.drug_exposure_start_date))asend_date,C.drug_concept_idasTARGET_CONCEPT_ID,C.visit_occurrence_idfrom(selectde.*,row_number()over(PARTITIONBYde.person_idORDERBYde.drug_exposure_start_date,de.drug_exposure_id)asordinalFROM@cdm_database_schema.DRUG_EXPOSUREdewherede.drug_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=24))C--EndDrugExposureCriteria)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=DATEADD(day,-7,P.START_DATE)andA.START_DATE<=DATEADD(day,7,P.START_DATE)GROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteriaUNIONALL--BeginCriteriaGroupselect1asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=15))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)ELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=15))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)PLEFTJOIN(--BeginProcedureOccurrenceCriteriaselectC.person_id,C.procedure_occurrence_idasevent_id,C.procedure_dateasstart_date,DATEADD(d,1,C.procedure_date)asEND_DATE,C.procedure_concept_idasTARGET_CONCEPT_ID,C.visit_occurrence_idfrom(selectpo.*,row_number()over(PARTITIONBYpo.person_idORDERBYpo.procedure_date,po.procedure_occurrence_id)asordinalFROM@cdm_database_schema.PROCEDURE_OCCURRENCEpowherepo.procedure_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=18))C--EndProcedureOccurrenceCriteria)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=DATEADD(day,-7,P.START_DATE)andA.START_DATE<=DATEADD(day,7,P.START_DATE)GROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteriaUNIONALL--BeginCriteriaGroupselect1asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=15))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)ELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=15))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)PLEFTJOIN(--BeginProcedureOccurrenceCriteriaselectC.person_id,C.procedure_occurrence_idasevent_id,C.procedure_dateasstart_date,DATEADD(d,1,C.procedure_date)asEND_DATE,C.procedure_concept_idasTARGET_CONCEPT_ID,C.visit_occurrence_idfrom(selectpo.*,row_number()over(PARTITIONBYpo.person_idORDERBYpo.procedure_date,po.procedure_occurrence_id)asordinalFROM@cdm_database_schema.PROCEDURE_OCCURRENCEpowherepo.procedure_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=17))C--EndProcedureOccurrenceCriteria)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=DATEADD(day,-7,P.START_DATE)andA.START_DATE<=DATEADD(day,7,P.START_DATE)GROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteriaUNIONALL--BeginCriteriaGroupselect1asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=15))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)ELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=15))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)PLEFTJOIN(--BeginProcedureOccurrenceCriteriaselectC.person_id,C.procedure_occurrence_idasevent_id,C.procedure_dateasstart_date,DATEADD(d,1,C.procedure_date)asEND_DATE,C.procedure_concept_idasTARGET_CONCEPT_ID,C.visit_occurrence_idfrom(selectpo.*,row_number()over(PARTITIONBYpo.person_idORDERBYpo.procedure_date,po.procedure_occurrence_id)asordinalFROM@cdm_database_schema.PROCEDURE_OCCURRENCEpowherepo.procedure_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=16))C--EndProcedureOccurrenceCriteria)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=DATEADD(day,-7,P.START_DATE)andA.START_DATE<=DATEADD(day,7,P.START_DATE)GROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteriaUNIONALL--BeginCorrelatedCriteriaSELECT1asindex_id,p.person_id,p.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=15))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)PLEFTJOIN(--BeginProcedureOccurrenceCriteriaselectC.person_id,C.procedure_occurrence_idasevent_id,C.procedure_dateasstart_date,DATEADD(d,1,C.procedure_date)asEND_DATE,C.procedure_concept_idasTARGET_CONCEPT_ID,C.visit_occurrence_idfrom(selectpo.*,row_number()over(PARTITIONBYpo.person_idORDERBYpo.procedure_date,po.procedure_occurrence_id)asordinalFROM@cdm_database_schema.PROCEDURE_OCCURRENCEpowherepo.procedure_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=13))C--EndProcedureOccurrenceCriteria)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=DATEADD(day,-7,P.START_DATE)andA.START_DATE<=DATEADD(day,7,P.START_DATE)GROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteria)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)>0)G--EndCriteriaGroup)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)>0)G--EndCriteriaGroup)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)>0)G--EndCriteriaGroup)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)=2)G--EndCriteriaGroup)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)=2)G--EndCriteriaGroup)AConAC.person_id=pe.person_idandAC.event_id=pe.event_id)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=P.OP_START_DATEandA.START_DATE<=P.OP_END_DATEGROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteriaUNIONALL--BeginCriteriaGroupselect1asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM#qualified_eventsELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM#qualified_eventsPLEFTJOIN(selectPE.person_id,PE.event_id,PE.start_date,PE.end_date,PE.target_concept_id,PE.visit_occurrence_idFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=12))C--EndConditionOccurrenceCriteria)PEJOIN(--BeginCriteriaGroupselect0asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=12))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)ELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=12))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)PLEFTJOIN(--BeginDrugExposureCriteriaselectC.person_id,C.drug_exposure_idasevent_id,C.drug_exposure_start_dateasstart_date,COALESCE(C.drug_exposure_end_date,DATEADD(day,1,C.drug_exposure_start_date))asend_date,C.drug_concept_idasTARGET_CONCEPT_ID,C.visit_occurrence_idfrom(selectde.*,row_number()over(PARTITIONBYde.person_idORDERBYde.drug_exposure_start_date,de.drug_exposure_id)asordinalFROM@cdm_database_schema.DRUG_EXPOSUREdewherede.drug_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=24))C--EndDrugExposureCriteria)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=DATEADD(day,-7,P.START_DATE)andA.START_DATE<=DATEADD(day,7,P.START_DATE)GROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteriaUNIONALL--BeginCriteriaGroupselect1asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=12))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)ELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=12))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)PLEFTJOIN(--BeginProcedureOccurrenceCriteriaselectC.person_id,C.procedure_occurrence_idasevent_id,C.procedure_dateasstart_date,DATEADD(d,1,C.procedure_date)asEND_DATE,C.procedure_concept_idasTARGET_CONCEPT_ID,C.visit_occurrence_idfrom(selectpo.*,row_number()over(PARTITIONBYpo.person_idORDERBYpo.procedure_date,po.procedure_occurrence_id)asordinalFROM@cdm_database_schema.PROCEDURE_OCCURRENCEpowherepo.procedure_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=13))C--EndProcedureOccurrenceCriteria)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=DATEADD(day,-7,P.START_DATE)andA.START_DATE<=DATEADD(day,7,P.START_DATE)GROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteriaUNIONALL--BeginCorrelatedCriteriaSELECT1asindex_id,p.person_id,p.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=12))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)PLEFTJOIN(--BeginProcedureOccurrenceCriteriaselectC.person_id,C.procedure_occurrence_idasevent_id,C.procedure_dateasstart_date,DATEADD(d,1,C.procedure_date)asEND_DATE,C.procedure_concept_idasTARGET_CONCEPT_ID,C.visit_occurrence_idfrom(selectpo.*,row_number()over(PARTITIONBYpo.person_idORDERBYpo.procedure_date,po.procedure_occurrence_id)asordinalFROM@cdm_database_schema.PROCEDURE_OCCURRENCEpowherepo.procedure_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=14))C--EndProcedureOccurrenceCriteria)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=DATEADD(day,-7,P.START_DATE)andA.START_DATE<=DATEADD(day,7,P.START_DATE)GROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteria)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)>0)G--EndCriteriaGroup)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)=2)G--EndCriteriaGroup)AConAC.person_id=pe.person_idandAC.event_id=pe.event_id)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=P.OP_START_DATEandA.START_DATE<=P.OP_END_DATEGROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteriaUNIONALL--BeginCriteriaGroupselect1asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM#qualified_eventsELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM#qualified_eventsPLEFTJOIN(selectPE.person_id,PE.event_id,PE.start_date,PE.end_date,PE.target_concept_id,PE.visit_occurrence_idFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=10))C--EndConditionOccurrenceCriteria)PEJOIN(--BeginCriteriaGroupselect0asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=10))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)ELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=10))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)PLEFTJOIN(--BeginDrugExposureCriteriaselectC.person_id,C.drug_exposure_idasevent_id,C.drug_exposure_start_dateasstart_date,COALESCE(C.drug_exposure_end_date,DATEADD(day,1,C.drug_exposure_start_date))asend_date,C.drug_concept_idasTARGET_CONCEPT_ID,C.visit_occurrence_idfrom(selectde.*,row_number()over(PARTITIONBYde.person_idORDERBYde.drug_exposure_start_date,de.drug_exposure_id)asordinalFROM@cdm_database_schema.DRUG_EXPOSUREdewherede.drug_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=24))C--EndDrugExposureCriteria)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=DATEADD(day,-7,P.START_DATE)andA.START_DATE<=DATEADD(day,7,P.START_DATE)GROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteriaUNIONALL--BeginCriteriaGroupselect1asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=10))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)ELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=10))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)PLEFTJOIN(--BeginMeasurementCriteriaselectC.person_id,C.measurement_idasevent_id,C.measurement_dateasstart_date,DATEADD(d,1,C.measurement_date)asEND_DATE,C.measurement_concept_idasTARGET_CONCEPT_ID,C.visit_occurrence_idfrom(selectm.*,row_number()over(PARTITIONBYm.person_idORDERBYm.measurement_date,m.measurement_id)asordinalFROM@cdm_database_schema.MEASUREMENTmwherem.measurement_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=11))C--EndMeasurementCriteria)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=DATEADD(day,-7,P.START_DATE)andA.START_DATE<=DATEADD(day,7,P.START_DATE)GROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteriaUNIONALL--BeginCorrelatedCriteriaSELECT1asindex_id,p.person_id,p.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=10))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)PLEFTJOIN(--BeginDrugExposureCriteriaselectC.person_id,C.drug_exposure_idasevent_id,C.drug_exposure_start_dateasstart_date,COALESCE(C.drug_exposure_end_date,DATEADD(day,1,C.drug_exposure_start_date))asend_date,C.drug_concept_idasTARGET_CONCEPT_ID,C.visit_occurrence_idfrom(selectde.*,row_number()over(PARTITIONBYde.person_idORDERBYde.drug_exposure_start_date,de.drug_exposure_id)asordinalFROM@cdm_database_schema.DRUG_EXPOSUREdewherede.drug_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=24))C--EndDrugExposureCriteria)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=DATEADD(day,-7,P.START_DATE)andA.START_DATE<=DATEADD(day,7,P.START_DATE)GROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteria)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)>0)G--EndCriteriaGroup)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)=2)G--EndCriteriaGroup)AConAC.person_id=pe.person_idandAC.event_id=pe.event_id)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=P.OP_START_DATEandA.START_DATE<=P.OP_END_DATEGROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteriaUNIONALL--BeginCriteriaGroupselect1asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM#qualified_eventsELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM#qualified_eventsPLEFTJOIN(selectPE.person_id,PE.event_id,PE.start_date,PE.end_date,PE.target_concept_id,PE.visit_occurrence_idFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=0))C--EndConditionOccurrenceCriteria)PEJOIN(--BeginCriteriaGroupselect0asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=0))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)ELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=0))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)PLEFTJOIN(--BeginMeasurementCriteriaselectC.person_id,C.measurement_idasevent_id,C.measurement_dateasstart_date,DATEADD(d,1,C.measurement_date)asEND_DATE,C.measurement_concept_idasTARGET_CONCEPT_ID,C.visit_occurrence_idfrom(selectm.*,row_number()over(PARTITIONBYm.person_idORDERBYm.measurement_date,m.measurement_id)asordinalFROM@cdm_database_schema.MEASUREMENTmwherem.measurement_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=1))CWHEREC.value_as_number>=0.5000--EndMeasurementCriteria)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=DATEADD(day,-7,P.START_DATE)andA.START_DATE<=DATEADD(day,7,P.START_DATE)GROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteriaUNIONALL--BeginCriteriaGroupselect1asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=0))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)ELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=0))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)PLEFTJOIN(--BeginProcedureOccurrenceCriteriaselectC.person_id,C.procedure_occurrence_idasevent_id,C.procedure_dateasstart_date,DATEADD(d,1,C.procedure_date)asEND_DATE,C.procedure_concept_idasTARGET_CONCEPT_ID,C.visit_occurrence_idfrom(selectpo.*,row_number()over(PARTITIONBYpo.person_idORDERBYpo.procedure_date,po.procedure_occurrence_id)asordinalFROM@cdm_database_schema.PROCEDURE_OCCURRENCEpowherepo.procedure_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=2))C--EndProcedureOccurrenceCriteria)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=DATEADD(day,-7,P.START_DATE)andA.START_DATE<=DATEADD(day,7,P.START_DATE)GROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteriaUNIONALL--BeginCorrelatedCriteriaSELECT1asindex_id,p.person_id,p.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=0))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)PLEFTJOIN(--BeginProcedureOccurrenceCriteriaselectC.person_id,C.procedure_occurrence_idasevent_id,C.procedure_dateasstart_date,DATEADD(d,1,C.procedure_date)asEND_DATE,C.procedure_concept_idasTARGET_CONCEPT_ID,C.visit_occurrence_idfrom(selectpo.*,row_number()over(PARTITIONBYpo.person_idORDERBYpo.procedure_date,po.procedure_occurrence_id)asordinalFROM@cdm_database_schema.PROCEDURE_OCCURRENCEpowherepo.procedure_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=3))C--EndProcedureOccurrenceCriteria)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=DATEADD(day,-7,P.START_DATE)andA.START_DATE<=DATEADD(day,7,P.START_DATE)GROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteria)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)>0)G--EndCriteriaGroup)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)=2)G--EndCriteriaGroup)AConAC.person_id=pe.person_idandAC.event_id=pe.event_id)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=P.OP_START_DATEandA.START_DATE<=P.OP_END_DATEGROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteriaUNIONALL--BeginCorrelatedCriteriaSELECT1asindex_id,p.person_id,p.event_idFROM#qualified_eventsPLEFTJOIN(selectPE.person_id,PE.event_id,PE.start_date,PE.end_date,PE.target_concept_id,PE.visit_occurrence_idFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=4))C--EndConditionOccurrenceCriteria)PEJOIN(--BeginCriteriaGroupselect0asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=4))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)ELEFTJOIN(--BeginCriteriaGroupselect0asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=4))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)ELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=4))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)PLEFTJOIN(--BeginVisitOccurrenceCriteriaselectC.person_id,C.visit_occurrence_idasevent_id,C.visit_start_dateasstart_date,C.visit_end_dateasend_date,C.visit_concept_idasTARGET_CONCEPT_ID,C.visit_occurrence_idfrom(selectvo.*,row_number()over(PARTITIONBYvo.person_idORDERBYvo.visit_start_date,vo.visit_occurrence_id)asordinalFROM@cdm_database_schema.VISIT_OCCURRENCEvowherevo.visit_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=7))C--EndVisitOccurrenceCriteria)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=DATEADD(day,-7,P.START_DATE)andA.START_DATE<=DATEADD(day,7,P.START_DATE)GROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteriaUNIONALL--BeginCriteriaGroupselect1asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=4))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)ELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=4))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)PLEFTJOIN(--BeginProcedureOccurrenceCriteriaselectC.person_id,C.procedure_occurrence_idasevent_id,C.procedure_dateasstart_date,DATEADD(d,1,C.procedure_date)asEND_DATE,C.procedure_concept_idasTARGET_CONCEPT_ID,C.visit_occurrence_idfrom(selectpo.*,row_number()over(PARTITIONBYpo.person_idORDERBYpo.procedure_date,po.procedure_occurrence_id)asordinalFROM@cdm_database_schema.PROCEDURE_OCCURRENCEpowherepo.procedure_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=2))C--EndProcedureOccurrenceCriteria)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=DATEADD(day,-7,P.START_DATE)andA.START_DATE<=DATEADD(day,7,P.START_DATE)GROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteriaUNIONALL--BeginCriteriaGroupselect1asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=4))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)ELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=4))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)PLEFTJOIN(--BeginDrugExposureCriteriaselectC.person_id,C.drug_exposure_idasevent_id,C.drug_exposure_start_dateasstart_date,COALESCE(C.drug_exposure_end_date,DATEADD(day,1,C.drug_exposure_start_date))asend_date,C.drug_concept_idasTARGET_CONCEPT_ID,C.visit_occurrence_idfrom(selectde.*,row_number()over(PARTITIONBYde.person_idORDERBYde.drug_exposure_start_date,de.drug_exposure_id)asordinalFROM@cdm_database_schema.DRUG_EXPOSUREdewherede.drug_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=5))C--EndDrugExposureCriteria)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=DATEADD(day,-7,P.START_DATE)andA.START_DATE<=DATEADD(day,7,P.START_DATE)GROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteriaUNIONALL--BeginCorrelatedCriteriaSELECT1asindex_id,p.person_id,p.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=4))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)PLEFTJOIN(--BeginProcedureOccurrenceCriteriaselectC.person_id,C.procedure_occurrence_idasevent_id,C.procedure_dateasstart_date,DATEADD(d,1,C.procedure_date)asEND_DATE,C.procedure_concept_idasTARGET_CONCEPT_ID,C.visit_occurrence_idfrom(selectpo.*,row_number()over(PARTITIONBYpo.person_idORDERBYpo.procedure_date,po.procedure_occurrence_id)asordinalFROM@cdm_database_schema.PROCEDURE_OCCURRENCEpowherepo.procedure_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=6))C--EndProcedureOccurrenceCriteria)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=DATEADD(day,-7,P.START_DATE)andA.START_DATE<=DATEADD(day,7,P.START_DATE)GROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteria)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)=2)G--EndCriteriaGroup)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)=2)G--EndCriteriaGroup)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)=2)G--EndCriteriaGroupUNIONALL--BeginCriteriaGroupselect1asindex_id,person_id,event_idFROM(selectE.person_id,E.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=4))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)ELEFTJOIN(--BeginCorrelatedCriteriaSELECT0asindex_id,p.person_id,p.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=4))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)PLEFTJOIN(--BeginProcedureOccurrenceCriteriaselectC.person_id,C.procedure_occurrence_idasevent_id,C.procedure_dateasstart_date,DATEADD(d,1,C.procedure_date)asEND_DATE,C.procedure_concept_idasTARGET_CONCEPT_ID,C.visit_occurrence_idfrom(selectpo.*,row_number()over(PARTITIONBYpo.person_idORDERBYpo.procedure_date,po.procedure_occurrence_id)asordinalFROM@cdm_database_schema.PROCEDURE_OCCURRENCEpowherepo.procedure_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=8))C--EndProcedureOccurrenceCriteria)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=DATEADD(day,-7,P.START_DATE)andA.START_DATE<=DATEADD(day,7,P.START_DATE)GROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteriaUNIONALL--BeginCorrelatedCriteriaSELECT1asindex_id,p.person_id,p.event_idFROM(SELECTQ.person_id,Q.event_id,Q.start_date,Q.end_date,Q.visit_occurrence_id,OP.observation_period_start_dateasop_start_date,OP.observation_period_end_dateasop_end_dateFROM(--BeginConditionOccurrenceCriteriaSELECTC.person_id,C.condition_occurrence_idasevent_id,C.condition_start_dateasstart_date,COALESCE(C.condition_end_date,DATEADD(day,1,C.condition_start_date))asend_date,C.CONDITION_CONCEPT_IDasTARGET_CONCEPT_ID,C.visit_occurrence_idFROM(SELECTco.*,row_number()over(PARTITIONBYco.person_idORDERBYco.condition_start_date,co.condition_occurrence_id)asordinalFROM@cdm_database_schema.CONDITION_OCCURRENCEcowhereco.condition_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=4))C--EndConditionOccurrenceCriteria)QJOIN@cdm_database_schema.OBSERVATION_PERIODOPonQ.person_id=OP.person_idandOP.observation_period_start_date<=Q.start_dateandOP.observation_period_end_date>=Q.start_date)PLEFTJOIN(--BeginProcedureOccurrenceCriteriaselectC.person_id,C.procedure_occurrence_idasevent_id,C.procedure_dateasstart_date,DATEADD(d,1,C.procedure_date)asEND_DATE,C.procedure_concept_idasTARGET_CONCEPT_ID,C.visit_occurrence_idfrom(selectpo.*,row_number()over(PARTITIONBYpo.person_idORDERBYpo.procedure_date,po.procedure_occurrence_id)asordinalFROM@cdm_database_schema.PROCEDURE_OCCURRENCEpowherepo.procedure_concept_idin(SELECTconcept_idfrom#Codesetswherecodeset_id=9))C--EndProcedureOccurrenceCriteria)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=DATEADD(day,-7,P.START_DATE)andA.START_DATE<=DATEADD(day,7,P.START_DATE)GROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteria)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)>0)G--EndCriteriaGroup)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)=2)G--EndCriteriaGroup)AConAC.person_id=pe.person_idandAC.event_id=pe.event_id)AonA.person_id=P.person_idandA.START_DATE>=P.OP_START_DATEANDA.START_DATE<=P.OP_END_DATEANDA.START_DATE>=P.OP_START_DATEandA.START_DATE<=P.OP_END_DATEGROUPBYp.person_id,p.event_idHAVINGCOUNT(A.TARGET_CONCEPT_ID)>=1--EndCorrelatedCriteria)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)>0)G--EndCriteriaGroup)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)>0)G--EndCriteriaGroup)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)>0)G--EndCriteriaGroup)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)>0)G--EndCriteriaGroup)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)>0)G--EndCriteriaGroup)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)>0)G--EndCriteriaGroup)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)>0)G--EndCriteriaGroup)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)>0)G--EndCriteriaGroup)CQonE.person_id=CQ.person_idandE.event_id=CQ.event_idGROUPBYE.person_id,E.event_idHAVINGCOUNT(index_id)>0)G--EndCriteriaGroup)AConAC.person_id=pe.person_idANDAC.event_id=pe.event_id)Results;SELECTinclusion_rule_id,person_id,event_idINTO#inclusion_eventsFROM(selectinclusion_rule_id,person_id,event_idfrom#Inclusion_0)I;TRUNCATETABLE#Inclusion_0;DROPTABLE#Inclusion_0;withcteIncludedEvents(event_id,person_id,start_date,end_date,op_start_date,op_end_date,ordinal)as(SELECTevent_id,person_id,start_date,end_date,op_start_date,op_end_date,row_number()over(partitionbyperson_idorderbystart_dateASC)asordinalfrom(selectQ.event_id,Q.person_id,Q.start_date,Q.end_date,Q.op_start_date,Q.op_end_date,SUM(coalesce(POWER(cast(2asbigint),I.inclusion_rule_id),0))asinclusion_rule_maskfrom#qualified_eventsQLEFTJOIN#inclusion_eventsIonI.person_id=Q.person_idandI.event_id=Q.event_idGROUPBYQ.event_id,Q.person_id,Q.start_date,Q.end_date,Q.op_start_date,Q.op_end_date)MG--matchinggroups{1!=0}?{--thematchinggroupwithallbitsset(POWER(2,#ofinclusionrules)-1=inclusion_rule_maskWHERE(MG.inclusion_rule_mask=POWER(cast(2asbigint),1)-1)})selectevent_id,person_id,start_date,end_date,op_start_date,op_end_dateinto#included_eventsFROMcteIncludedEventsResultsWHEREResults.ordinal=1;--generatecohortperiodsinto#final_cohortwithcohort_ends(event_id,person_id,end_date)as(--cohortexitdates--Bydefault,cohortexitattheevent'sopenddateselectevent_id,person_id,op_end_dateasend_datefrom#included_events),first_ends(person_id,start_date,end_date)as(selectF.person_id,F.start_date,F.end_dateFROM(selectI.event_id,I.person_id,I.start_date,E.end_date,row_number()over(partitionbyI.person_id,I.event_idorderbyE.end_date)asordinalfrom#included_eventsIjoincohort_endsEonI.event_id=E.event_idandI.person_id=E.person_idandE.end_date>=I.start_date)FWHEREF.ordinal=1)selectperson_id,start_date,end_dateINTO#cohort_rowsfromfirst_ends;withcteEndDates(person_id,end_date)AS--themagic(SELECTperson_id,DATEADD(day,-1*0,event_date)asend_dateFROM(SELECTperson_id,event_date,event_type,MAX(start_ordinal)OVER(PARTITIONBYperson_idORDERBYevent_date,event_typeROWSUNBOUNDEDPRECEDING)ASstart_ordinal,ROW_NUMBER()OVER(PARTITIONBYperson_idORDERBYevent_date,event_type)ASoverall_ordFROM(SELECTperson_id,start_dateASevent_date,-1ASevent_type,ROW_NUMBER()OVER(PARTITIONBYperson_idORDERBYstart_date)ASstart_ordinalFROM#cohort_rowsUNIONALLSELECTperson_id,DATEADD(day,0,end_date)asend_date,1ASevent_type,NULLFROM#cohort_rows)RAWDATA)eWHERE(2*e.start_ordinal)-e.overall_ord=0),cteEnds(person_id,start_date,end_date)AS(SELECTc.person_id,c.start_date,MIN(e.end_date)ASera_end_dateFROM#cohort_rowscJOINcteEndDateseONc.person_id=e.person_idANDe.end_date>=c.start_dateGROUPBYc.person_id,c.start_date)selectperson_id,min(start_date)asstart_date,end_dateinto#final_cohortfromcteEndsgroupbyperson_id,end_date;DELETEFROM@target_database_schema.@target_cohort_tablewherecohort_definition_id=@target_cohort_id;INSERTINTO@target_database_schema.@target_cohort_table(cohort_definition_id,subject_id,cohort_start_date,cohort_end_date)select@target_cohort_idascohort_definition_id,person_id,start_date,end_dateFROM#final_cohortCO;{@generateStats!=0}?{--calcultematchinggroupcountsdeletefrom@results_database_schema.cohort_inclusion_resultwherecohort_definition_id=@target_cohort_id;insertinto@results_database_schema.cohort_inclusion_result(cohort_definition_id,inclusion_rule_mask,person_count)select@target_cohort_idascohort_definition_id,inclusion_rule_mask,count(*)asperson_countfrom(selectQ.person_id,Q.event_id,CAST(SUM(coalesce(POWER(cast(2asbigint),I.inclusion_rule_id),0))ASbigint)asinclusion_rule_maskfrom#qualified_eventsQLEFTJOIN#inclusion_eventsIonq.person_id=i.person_idandq.event_id=i.event_idGROUPBYQ.person_id,Q.event_id)MG--matchinggroupsgroupbyinclusion_rule_mask;--calculategaincountsdeletefrom@results_database_schema.cohort_inclusion_statswherecohort_definition_id=@target_cohort_id;insertinto@results_database_schema.cohort_inclusion_stats(cohort_definition_id,rule_sequence,person_count,gain_count,person_total)selectir.cohort_definition_id,ir.rule_sequence,coalesce(T.person_count,0)asperson_count,coalesce(SR.person_count,0)gain_count,EventTotal.totalfrom@results_database_schema.cohort_inclusionirleftjoin(selecti.inclusion_rule_id,count(i.event_id)asperson_countfrom#qualified_eventsQJOIN#inclusion_eventsionQ.person_id=I.person_idandQ.event_id=i.event_idgroupbyi.inclusion_rule_id)Tonir.rule_sequence=T.inclusion_rule_idCROSSJOIN(selectcount(*)astotal_rulesfrom@results_database_schema.cohort_inclusionwherecohort_definition_id=@target_cohort_id)RuleTotalCROSSJOIN(selectcount(event_id)astotalfrom#qualified_events)EventTotalLEFTJOIN@results_database_schema.cohort_inclusion_resultSRonSR.cohort_definition_id=@target_cohort_idAND(POWER(cast(2asbigint),RuleTotal.total_rules)-POWER(cast(2asbigint),ir.rule_sequence)-1)=SR.inclusion_rule_mask--POWER(2,rulecount)-POWER(2,rulesequence)-1isthemaskfor'allexceptthisrule'WHEREir.cohort_definition_id=@target_cohort_id;--calculatetotalsdeletefrom@results_database_schema.cohort_summary_statswherecohort_definition_id=@target_cohort_id;insertinto@results_database_schema.cohort_summary_stats(cohort_definition_id,base_count,final_count)select@target_cohort_idascohort_definition_id,PC.totalasperson_count,coalesce(FC.total,0)asfinal_countFROM(selectcount(event_id)astotalfrom#qualified_events)PC,(selectsum(sr.person_count)astotalfrom@results_database_schema.cohort_inclusion_resultsrCROSSJOIN(selectcount(*)astotal_rulesfrom@results_database_schema.cohort_inclusionwherecohort_definition_id=@target_cohort_id)RuleTotalwherecohort_definition_id=@target_cohort_idandsr.inclusion_rule_mask=POWER(cast(2asbigint),RuleTotal.total_rules)-1)FC;}TRUNCATETABLE#cohort_rows;DROPTABLE#cohort_rows;TRUNCATETABLE#final_cohort;DROPTABLE#final_cohort;TRUNCATETABLE#inclusion_events;DROPTABLE#inclusion_events;TRUNCATETABLE#qualified_events;DROPTABLE#qualified_events;TRUNCATETABLE#included_events;DROPTABLE#included_events;TRUNCATETABLE#Codesets;DROPTABLE#Codesets;
